version: '3.8'

services:
  web:
    build:
      context: .
      args:
        HYRAX_TARGET: main
    command: server
    image: nurax-pg
    stdin_open: true
    tty: true
    restart: always
    user: root
    env_file:
      - .env.docker
    depends_on:
      - chrome
      - db_migrate
      - postgres
      - redis
      - solr
    ports:
      - 3000:3000
    volumes:
      - .:/data:cached
      - nurax-data:/var/nurax-data
    networks:
      - nurax-pg

  sidekiq:
    command: sidekiq
    image: nurax-pg
    restart: always
    user: root
    env_file:
      - .env.docker
    depends_on:
      - db_migrate
      - postgres
      - redis
      - solr
    volumes:
      - .:/data:cached
      - nurax-data:/var/nurax-data
    networks:
      - nurax-pg

  chrome:
    image: seleniarm/standalone-chromium:4.10
    logging:
      driver: none
    volumes:
      - /dev/shm:/dev/shm
    shm_size: 2G
    ports:
      - "4444:4444"
      - "5959:5900"
    networks:
      - nurax-pg

  db_migrate:
    image: nurax-pg
    env_file:
      - .env.docker
    command:
      - sh
      - -c
      - >
        bundle exec rails db:create &&
        bundle exec rails db:migrate &&
        bundle exec rails db:seed
    restart: on-failure
    depends_on:
      - postgres
      - solr
    volumes:
      - .:/data:cached
      - nurax-data:/var/nurax-data
    networks:
      - nurax-pg

  postgres:
    image: bitnami/postgresql:14
    restart: always
    env_file:
      - .env.docker
    # ports:
    #   - "5432:5432"
    volumes:
      - db:/bitnami/postgresql
    networks:
      - nurax-pg

  redis:
    image: bitnami/redis:6.2
    env_file:
      - .env.docker
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
    volumes:
      - redis:/bitnami/redis/data
    networks:
      - nurax-pg

  solr:
    image: bitnami/solr:8.11.2
    ports:
      - 8983:8983
    env_file:
      - .env.docker
    restart: on-failure
    ulimits:
      nofile:
        soft: 65536
        hard: 524288
    volumes:
      - ./solr/conf:/opt/nurax-pg
      - solr_home:/bitnami
    networks:
      - nurax-pg

volumes:
  db:
  nurax-data:
  redis:
  solr_home:

networks:
  nurax-pg:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-nurax-pg
